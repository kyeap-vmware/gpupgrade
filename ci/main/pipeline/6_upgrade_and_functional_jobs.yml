{{range .UpgradeJobs}}
- name: {{ .Name }}
  serial_groups: [{{ .SerialGroup }}]
  # Specifying serial groups so that only one platform runs at a time. For
  # example, 5-to-6-centos7 will only run after 5-to-6-centos6 completes. This
  # will prevent concourse from becoming overloaded.
  plan:
    - in_parallel:
        - get: enterprise_rpm
          trigger: true
          passed: [ build ]
        - get: gpupgrade_src
          passed: [ build ]
        - get: rpm_gpdb_source
          resource: gpdb{{.Source}}_{{.Platform}}_rpm
          trigger: true
        {{- if ne .Source .Target }}
        - get: rpm_gpdb_target
          resource: gpdb{{.Target}}_{{.Platform}}_rpm
          trigger: true
        {{- end }}
        - get: ccp_src
        - get: terraform.d
          params:
            unpack: true
        {{- if .RetailDemo }}
        - get: retail_demo_src
        {{- else }}
        # FIXME: this is not guaranteed to be the same dump generated by the
        # above binary...
        - get: sqldump
          {{- if .TestExtensions }}
          resource: postgis_2.1.5_dump
          {{- else if eq (.Source) "5" }}
          resource: icw_planner_gpdb5_centos6_dump
          {{- else }}
          resource: icw_gporca_gpdb6_centos6_dump
          {{- end }}
        {{- end }}
        {{- if .TestExtensions }}
        - get: gptext_targz_source
          resource: gptext_3.x_gpdb{{.Source}}_{{.RpmVersion}}_targz
        - get: gptext_targz_target
          resource: gptext_3.x_gpdb{{.Target}}_{{.RpmVersion}}_targz
        - get: postgis_gppkg_source
          resource: postgis_2.x_gpdb{{.Source}}_{{.Platform}}_gppkg
        - get: postgis_gppkg_target
          resource: postgis_2.x_gpdb{{.Target}}_{{.Platform}}_gppkg
        - get: madlib_gppkg_source
          resource: madlib_1.x_gpdb{{.Source}}_{{.Platform}}_gppkg
        - get: madlib_gppkg_target
          resource: madlib_1.x_gpdb{{.Target}}_{{.Platform}}_gppkg
        - get: plr_gppkg_source
          resource: plr_gpdb{{.Source}}_{{.Platform}}_gppkg
        - get: plr_gppkg_target
          resource: plr_gpdb{{.Target}}_{{.Platform}}_gppkg
        {{- if eq .Platform "centos7" }}
        - get: pxf_rpm_source
          resource: pxf_6_gpdb{{.Source}}_{{.Platform}}_rpm
        - get: pxf_rpm_target
          resource: pxf_6_gpdb{{.Target}}_{{.Platform}}_rpm
        - get: plcontainer_gppkg_source
          resource: plcontainer_1.x_gpdb5_{{.Platform}}_gppkg
        - get: plcontainer_gppkg_target
          resource: plcontainer_2.x_gpdb6_{{.Platform}}_gppkg
        {{- end }}
        {{- end }}
    - put: terraform
      params:
        <<: *ccp_default_params
        vars:
          {{- if .PrimariesOnly}}
          mirrors: false
          {{- else if not .NoStandby}}
          standby_coordinator: true
          {{- end}}
          instance_type: n1-standard-2
          number_of_nodes: 4
          PLATFORM: {{.Platform}}
          # Decrease the reap time from the default of 8 hours now that there are
          # both centos6 and centos7 jobs in order to not overload concourse.
          ccp_reap_minutes: 180
    - task: gen_source_cluster
      file: ccp_src/ci/tasks/gen_cluster.yml
      params:
        <<: *ccp_gen_cluster_default_params
        PLATFORM: {{.Platform}}
        GPDB_RPM: true
      input_mapping:
        gpdb_rpm: rpm_gpdb_source
    - task: gpinitsystem_source_cluster
      file: ccp_src/ci/tasks/gpinitsystem.yml
    - task: prepare_installation
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: registry.access.redhat.com/ubi8/ubi
            tag: latest
        inputs:
          - name: gpupgrade_src
          - name: cluster_env_files
          - name: enterprise_rpm
          {{- if ne .Source .Target }}
          - name: rpm_gpdb_target
          {{- end }}
        run:
          path: gpupgrade_src/ci/main/scripts/prepare-installation.bash
          args:
            - greenplum-db-{{.Source}}
            - greenplum-db-{{.Target}}
    {{- if .RetailDemo }}
    - task: load_retail_data
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test
            tag: latest
        inputs:
          - name: gpupgrade_src
          - name: retail_demo_src
          - name: ccp_src
          - name: cluster_env_files
        run:
          path: gpupgrade_src/ci/main/scripts/load-retail-data.bash
    {{- else if .TestExtensions }}
    - task: load_extensions
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test-golang
            tag: latest
        params:
          GOOGLE_CREDENTIALS: ((upgrade/cm-gcs-service-account-key))
          OS_VERSION: {{.Platform}}
        inputs:
          - name: ccp_src
          - name: cluster_env_files
          - name: gpupgrade_src
          - name: gptext_targz_source
          - name: postgis_gppkg_source
          - name: madlib_gppkg_source
          - name: plr_gppkg_source
          - name: sqldump
          {{- if ne .Platform "centos6" }}
          - name: pxf_rpm_source
          - name: plcontainer_gppkg_source
          {{- end }}
        run:
          path: gpupgrade_src/ci/main/scripts/load-extensions.bash
    {{- else }}
    - task: load_dump
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test-golang
            tag: latest
        inputs:
          - name: ccp_src
          - name: cluster_env_files
          - name: gpupgrade_src
          - name: sqldump
        run:
          path: gpupgrade_src/ci/main/scripts/load-dump.bash
    {{- end }}
    {{- if .TestExtensions }}
    - task: upgrade_extensions
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test-golang
            tag: latest
        params:
          OS_VERSION: {{.Platform}}
        inputs:
          - name: ccp_src
          - name: cluster_env_files
          - name: gpupgrade_src
          - name: postgis_gppkg_target
          - name: madlib_gppkg_target
          - name: plr_gppkg_target
          {{- if ne .Platform "centos6" }}
          - name: pxf_rpm_target
          - name: plcontainer_gppkg_target
          {{- end }}
        run:
          path: gpupgrade_src/ci/main/scripts/upgrade-extensions.bash
      params:
        MODE: link
        FILTER_DIFF: 1
        DIFF_FILE: extensions.diff
    {{- else }}
    - task: upgrade_cluster
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test-golang
            tag: latest
        inputs:
          - name: ccp_src
          - name: cluster_env_files
          - name: gpupgrade_src
        run:
          path: gpupgrade_src/ci/main/scripts/upgrade-cluster.bash
      params:
        {{- if ne .Source .Target }}
        FILTER_DIFF: 1
        {{- end }}
        MODE: {{ .Mode }}
        {{- if .RetailDemo}}
        DIFF_FILE: retail_demo.diff
        {{- end }}
    {{- end }}
    - task: run_gpcheckcat
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test-golang
            tag: latest
        inputs:
          - name: gpupgrade_src
          - name: ccp_src
          - name: cluster_env_files
        run:
          path: bash
          args:
            - -c
            - |
              set -eux -o pipefail

              source gpupgrade_src/ci/main/scripts/environment.bash
              ./ccp_src/scripts/setup_ssh_to_cluster.sh

              echo "Running gpcheckcat..."
              time ssh -n cdw "
                  set -eux -o pipefail

                  source /usr/local/greenplum-db-target/greenplum_path.sh
                  export MASTER_DATA_DIRECTORY=$MASTER_DATA_DIRECTORY
                  export PGPORT=$PGPORT

                  gpcheckcat -A
              "
    {{- if not .NoStandby -}}
    {{- if not .PrimariesOnly }}
    - task: validate_mirrors_and_standby
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test-golang
            tag: latest
        inputs:
          - name: gpupgrade_src
          - name: ccp_src
          - name: cluster_env_files
        run:
          path: bash
          args:
            - -c
            - |
              set -eux -o pipefail

              ./ccp_src/scripts/setup_ssh_to_cluster.sh

              echo 'Doing failover tests of mirrors and standby...'
              source gpupgrade_src/testutils/validate_mirrors_and_standby/validate_mirrors_and_standby.bash
              validate_mirrors_and_standby /usr/local/greenplum-db-target cdw 5432
    {{- end -}}
    {{- end }}
  ensure:
    do:
      - <<: *set_failed
  on_success:
    do:
      - <<: *ccp_destroy
  on_failure:
    do:
      - <<: *slack_alert
{{end -}}
